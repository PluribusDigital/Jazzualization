<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css" />
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js" ></script>
    <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
    <script src="http://d3js.org/d3.v3.min.js"></script>

    <style>
        .link {
          stroke: #000;
          stroke-width: 1.5px;
        }

        .node {
          cursor: move;
          fill: none;
          stroke: #000;
          stroke-width: 1.5px;
        }
 
        .node text {
            pointer-events: none;
            font-family: 'Trebuchet MS', sans-serif;
            font-size: 1em;
            font-weight: lighter;
            text-anchor: middle;
        }

        .view {
            width: 100%;
            height: 600px;
        }

        .underlay {
            fill: white;
            pointer-events: visible;
        }
    </style>
    <title>Jazz-ualization!</title>
</head>
<body>
    <div class="container-fluid">
        <div class="row center-block">
            <h3 class="text-center">Jazz-ualization of Use Cases</h3>
        </div>
        <div class="row center-block">
            <svg class="view" id="view"></svg>
        </div>
    </div>

    <script>
        var colors = d3.scale.category20();
        var svg = d3.select(".view")
                    .append("g")
                    .call(d3.behavior.zoom().scaleExtent([.25, 8]).on("zoom", zoom))
                    .append("g");

        var width = Math.max(document.getElementById('view').offsetWidth, 960),
            height = Math.max(document.getElementById('view').offsetHeight, 600),
            root;

        svg.append("rect")
           .attr("class", "underlay")
           .attr("width", width)
           .attr("height", height);

        var radius = Math.sqrt(width * height) / 20;

        var force = d3.layout.force()
            .size([width, height])
            .on("tick", tick);

        var drag = force.drag()
            .on("dragstart", dragstart);

        var link = svg.selectAll(".link"),
            node = svg.selectAll(".node");

        d3.json("data/uc.json", function(error, json) {
            root = json;
            onModelLoaded();
        });

        function onModelLoaded() {
            var nodes = root.nodes.slice();
            var links = [];

            root.links.forEach(function (link) {
                var s = $.grep(nodes, function (x) { return x.id == link.source })[0],
                    t = $.grep(nodes, function (x) { return x.id == link.target })[0]
                links.push({ source: s, target: t });
            });

            // Update some settings based on the size of the data set
            radius = Math.max(Math.sqrt(width * height) / (nodes.length * 2), radius)

            // Restart the force layout.
            force
                .nodes(nodes)
                .links(links)
                .linkDistance(3 * radius)
                .charge(-5 * radius)
                .gravity(.025)
                .start();

            // Update links.
            link = link.data(links, function(d) { return d.target.id; });

            link.exit().remove();

            link.enter().insert("line", ".node")
                .attr("class", "link");

            // Update nodes.
            node = node.data(nodes, function(d) { return d.id; });

            node.exit().remove();

            var nodeEnter = node.enter().append("g")
                .attr("class", "node")
                .on("click", click)
                .on("dblclick", dblclick)
                .call(force.drag);

            nodeEnter.append("ellipse")
                .attr("rx", function (d) { return radius * 1.3; })
                .attr("ry", function (d) { return radius * 0.8; })
                .style("fill", color)

            nodeEnter.append("text")
                .attr("dy", ".35em")
                .text(function (d) { return d.name; });
        }

        function tick() {
            link.attr("x1", function(d) { return d.source.x; })
                .attr("y1", function(d) { return d.source.y; })
                .attr("x2", function(d) { return d.target.x; })
                .attr("y2", function(d) { return d.target.y; });

            node.attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });
        }

        function color(d) {
            index = 0;
            if (d.type == '')
                index = 10;
            return colors(index);
        }

        // Toggle children on click.
        function click(d) {
            if (d3.event.defaultPrevented) return; // ignore drag
        }

        function dblclick(d) {
            d3.select(this).classed("fixed", d.fixed = false);
        }

        function dragstart(d) {
            d3.select(this).classed("fixed", d.fixed = true);
        }

        function zoom() {
            svg.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
        }
    </script>
</body>
</html>
